kind: "CDN"
version: "1"
metadata:
  envTypes: ["prod"]

data:
  # ===========================================================================
  # CONSOLIDATED CDN CONFIGURATION
  # ===========================================================================
  # Domains:
  #   - tmp.asahi-kasei.com (temporary production, will become www.asahi-kasei.com)
  #   - preview.asahi-kasei.com (preview content)
  # Both domains mapped to prod publish tier, differentiated by origin routing
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # TRAFFIC FILTER RULES - Access Control & Security
  # ---------------------------------------------------------------------------
  trafficFilters:
    rules:
      # -------------------------------------------------------------------------
      # ACCESS CONTROL - IP Allowlist for Preview Domain (Always Restricted)
      # -------------------------------------------------------------------------
      - name: "preview-domain-ip-allowlist"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            - { reqProperty: domain, matches: "^preview\\.asahi-kasei\\.com$" }
            - { reqProperty: clientIp, notIn: [
                    # Adobe India Office
                    "103.43.112.0/24",
                    "103.43.114.0/24",
                    "130.248.110.0/24",
                    "130.248.111.0/24",
                    "130.248.112.0/24",
                    "130.248.113.0/24",
                    "130.248.114.0/24",
                    "130.248.115.0/24",
                    "130.248.124.0/24",
                    "130.248.125.0/24",
                    "130.248.126.0/24",
                    "130.248.127.0/24",
                    # Adobe Japan Office
                    "130.248.122.0/24",
                    "130.248.123.0/24",
                    # Asahi Kasei IP
                    "35.75.153.87/32",
                    "138.212.252.110/32",
                  ] }
        action:
          type: "block"

      # -------------------------------------------------------------------------
      # ACCESS CONTROL - IP Allowlist for Temporary Domain (Pre Go-Live Only)
      # -------------------------------------------------------------------------
      # NOTE: Remove or comment out this rule when switching to www.asahi-kasei.com
      - name: "tmp-domain-ip-allowlist"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            - { reqProperty: domain, matches: "^tmp\\.asahi-kasei\\.com$" }
            - { reqProperty: clientIp, notIn: [
                    # Adobe India Office
                    "103.43.112.0/24",
                    "103.43.114.0/24",
                    "130.248.110.0/24",
                    "130.248.111.0/24",
                    "130.248.112.0/24",
                    "130.248.113.0/24",
                    "130.248.114.0/24",
                    "130.248.115.0/24",
                    "130.248.124.0/24",
                    "130.248.125.0/24",
                    "130.248.126.0/24",
                    "130.248.127.0/24",
                    # Adobe Japan Office
                    "130.248.122.0/24",
                    "130.248.123.0/24",
                    # Asahi Kasei IP
                    "35.75.153.87/32",
                    "138.212.252.110/32",
                  ] }
        action:
          type: "block"

      # -------------------------------------------------------------------------
      # WAF RULES - Adobe Recommended Protection
      # -------------------------------------------------------------------------
      - name: "attacks-from-bad-ips-globally"
        when:
          reqProperty: tier
          in: ["author", "publish"]
        action:
          type: block
          wafFlags:
            - ATTACK-FROM-BAD-IP

      - name: "attacks-from-any-ips-globally"
        when:
          reqProperty: tier
          in: ["author", "publish"]
        action:
          type: log
          wafFlags:
            - ATTACK

      # -------------------------------------------------------------------------
      # DDOS MITIGATION - Rate Limiting
      # -------------------------------------------------------------------------
      - name: "limit-origin-requests-client-ip"
        when:
          reqProperty: tier
          equals: "publish"
        rateLimit:
          limit: 100
          window: 10
          count: fetches
          penalty: 300
          groupBy:
            - reqProperty: clientIp
        action: log

      - name: "limit-requests-client-ip"
        when:
          reqProperty: tier
          equals: "publish"
        rateLimit:
          limit: 500
          window: 10
          count: all
          penalty: 300
          groupBy:
            - reqProperty: clientIp
        action: log

      # Block OFAC sanctioned countries
      - name: "ofac-countries"
        when:
          allOf:
            - { reqProperty: tier, in: ["author", "publish"] }
            - reqProperty: clientCountry
              in:
                - SY # Syria
                - BY # Belarus
                - MM # Myanmar
                - KP # North Korea
                - IQ # Iraq
                - CD # Democratic Republic of Congo
                - SD # Sudan
                - IR # Iran
                - LR # Liberia
                - ZW # Zimbabwe
                - CU # Cuba
                - CI # Côte d'Ivoire
        action: block

  requestTransformations:
    rules:
      - name: set-auth-preview
        when:
          allOf:
            - { reqProperty: tier, equals: publish }
            - { reqProperty: domain, equals: "preview.asahi-kasei.com" }
        # Two steps to set the authorization header since secret references are not interpolated inside strings
        # 1. Set the authorization header to the site token
        # 2. Add "token " prefix
        actions:
          - type: set
            reqHeader: authorization
            value: "${{PREVIEW_AEM_SITE_TOKEN}}"
          - type: transform
            reqHeader: authorization
            op: replace
            match: "^(?!token\\s+)(.*)$"
            replacement: "token \\1"
      - name: set-auth-live
        when:
          allOf:
            - { reqProperty: tier, equals: publish }
            - { reqProperty: domain, equals: "tmp.asahi-kasei.com" }
        # Two steps to set the authorization header since secret references are not interpolated inside strings
        # 1. Set the authorization header to the site token
        # 2. Add "token " prefix
        actions:
          - type: set
            reqHeader: authorization
            value: "${{PROD_AEM_SITE_TOKEN}}"
          - type: transform
            reqHeader: authorization
            op: replace
            match: "^(?!token\\s+)(.*)$"
            replacement: "token \\1"

      # 1. Internal JP language rewrite
      - name: "preview-rewrite-jp-language-prefix"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            - { reqProperty: domain, equals: "preview.asahi-kasei.com" }
            - { reqProperty: path, matches: "^/jp(/.*)?$" }
            - { reqProperty: path, doesNotMatch: "^/jp/ja(/.*)?$" }
            # PROTECT JP ASSETS: Skip if path looks like a system/media file
            - { reqProperty: path, doesNotMatch: "^/(content|etc|icons|media_).*$" }
            - { reqProperty: path, doesNotMatch: ".*\\.(png|jpe?g|gif|webp|svg|pdf|css|js|ico)$" }
        actions:
          - type: transform
            reqProperty: path
            op: replace
            match: "^/jp(/.*)?$"
            replacement: "/jp/ja$1"

      # 2. Internal US language rewrite (The Catch-all)
      - name: "preview-rewrite-us-en-prefix"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            - { reqProperty: domain, equals: "preview.asahi-kasei.com" }
            # EXCLUSIONS: Don't rewrite if it's already a lang path
            - { reqProperty: path, doesNotMatch: "^/us/en(/.*)?$" }
            - { reqProperty: path, doesNotMatch: "^/jp(/.*)?$" }
            # PROTECT MEDIA & ICONS: Skip for root-level assets you mentioned
            - { reqProperty: path, doesNotMatch: "^/(content|etc|icons|media_).*$" }
            - { reqProperty: path, doesNotMatch: ".*\\.(png|jpe?g|gif|webp|svg|pdf|css|js|ico)$" }
        actions:
          - type: transform
            reqProperty: path
            op: replace
            match: "^/(.*)$"
            replacement: "/us/en/$1"
  # ---------------------------------------------------------------------------
  # ORIGIN SELECTORS - Domain-based routing to EDS origins
  # ---------------------------------------------------------------------------
  originSelectors:
    rules:
      # Route preview.asahi-kasei.com to .aem.page (preview content)
      - name: "route-to-eds-preview-content"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            - { reqProperty: domain, equals: "preview.asahi-kasei.com" }
        action:
          type: selectOrigin
          originName: aem-page-origin

      # Route tmp.asahi-kasei.com to .aem.live (production content)
      - name: "route-to-eds-live-content"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            - { reqProperty: domain, equals: "tmp.asahi-kasei.com" }
        action:
          type: selectOrigin
          originName: aem-live-origin

    # Origin definitions
    origins:
      # Preview content origin
      - name: aem-page-origin
        domain: main--ak-eds--adobe-acs-japan.aem.page
        forwardCookie: true
        forwardAuthorization: true

      # Production content origin
      - name: aem-live-origin
        domain: main--ak-eds--adobe-acs-japan.aem.live
        forwardCookie: true
        forwardAuthorization: true

  # ---------------------------------------------------------------------------
  # REDIRECT RULES
  # ---------------------------------------------------------------------------
  # Priority-ordered rules to handle URL normalization according to requirements:
  # 1. Uppercase to lowercase + underscore to hyphen conversion (301)
  # 2. index.html → parent directory without trailing slash (301)
  # 3. .html extension removal (301, except index.html)
  # 4. Trailing slash removal (301)
  # 5. /index paths → 404 (no redirect, default behavior)
  # 6. Clean paths without trailing slash → 200 OK (no redirect)
  # NOTE: All rules exclude asset files (images, CSS, JS, fonts, PDFs) to prevent breaking resources
  # ---------------------------------------------------------------------------
  redirects:
    rules:
      # Rule 1: Normalize case and underscores - non-asset paths
      # Examples:
      #   /jp/News/2023/E2403_29.html → /jp/news/2023/e2403-29.html
      #   /jp/News/2023/E2403_29      → /jp/news/2023/e2403-29
      - name: "normalize-case-and-underscores"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            # Do not touch assets: skip common binary/static extensions
            - reqProperty: path
              doesNotMatch: ".*\\.(png|jpe?g|gif|webp|svg|pdf|doc|docx|xls|xlsx|css|js|woff2?|ttf|eot)$"
            # Path contains uppercase or underscore
            - reqProperty: path
              matches: ".*[A-Z_].*"
        action:
          type: redirect
          status: 301
          location:
            reqProperty: path
            transform:
              - op: replace
                match: "_"
                replacement: "-"
              - op: tolower

      # Rule 2: index.html → parent (no trailing slash) - pages only
      # Example: /jp/news/index.html → /jp/news
      - name: "normalize-index-html-to-parent"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            # Do not touch assets
            - reqProperty: path
              doesNotMatch: ".*\\.(png|jpe?g|gif|webp|svg|pdf|doc|docx|xls|xlsx|css|js|woff2?|ttf|eot)$"
            - { reqProperty: path, matches: "^(.+)/index\\.html$" }
        action:
          type: redirect
          status: 301
          location:
            reqProperty: path
            transform:
              - op: replace
                match: "^(.+)/index\\.html$"
                replacement: "\\1"
      # Rule 3: Remove .html extension (excluding index.html and *.plain.html) - pages only
      # Example: /jp/news/2025/el250416.html → /jp/news/2025/el250416
      - name: "normalize-remove-html"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            # Do not touch assets
            - reqProperty: path
              doesNotMatch: ".*\\.(png|jpe?g|gif|webp|svg|pdf|doc|docx|xls|xlsx|css|js|woff2?|ttf|eot)$"
            - reqProperty: path
              # Must end with .html, but not /index.html or *.plain.html
              matches: "^(?!.*?/index\\.html$)(?!.*?\\.plain\\.html$).+\\.html$"
        action:
          type: redirect
          status: 301
          location:
            reqProperty: path
            transform:
              - op: replace
                match: "\\.html$"
                replacement: ""

      # Rule 4: Remove trailing slash (but not for root path) - pages only
      # Example: /jp/news/ → /jp/news
      - name: "normalize-remove-trailing-slash"
        when:
          allOf:
            - { reqProperty: tier, equals: "publish" }
            # Do not touch assets
            - reqProperty: path
              doesNotMatch: ".*\\.(png|jpe?g|gif|webp|svg|pdf|doc|docx|xls|xlsx|css|js|woff2?|ttf|eot)$"
            # Any non-root path ending with /
            - { reqProperty: path, matches: "^.+/$" }
        action:
          type: redirect
          status: 301
          location:
            reqProperty: path
            transform:
              - op: replace
                match: "/$"
                replacement: ""

  # ---------------------------------------------------------------------------
  # SECURITY HEADERS
  # ---------------------------------------------------------------------------
  responseTransformations:
    rules:
      - name: "security-headers"
        when:
          reqProperty: tier
          equals: "publish"
        actions:
          # HSTS - Force HTTPS for 1 year with preload
          - type: set
            respHeader: Strict-Transport-Security
            value: "max-age=31536000; includeSubDomains; preload"
          # Prevent MIME type sniffing
          - type: set
            respHeader: X-Content-Type-Options
            value: "nosniff"
          # Prevent clickjacking
          - type: set
            respHeader: X-Frame-Options
            value: "SAMEORIGIN"
          # Control referrer information
          - type: set
            respHeader: Referrer-Policy
            value: "strict-origin-when-cross-origin"
          # Disable sensitive browser features
          - type: set
            respHeader: Permissions-Policy
            value: "geolocation=(), microphone=(), camera=()"
          # Remove server version information
          - type: set
            respHeader: X-Powered-By
            value: ""

  # ---------------------------------------------------------------------------
  # ERROR PAGES CONFIGURATION
  # ---------------------------------------------------------------------------
  # Note: Error pages must be configured as a Single Page Application (SPA)
  # hosted on external storage (S3, Azure Blob Storage, etc.)
  #
  # Example configuration:
  # errorPages:
  #   spa:
  #     title: "Error Page"
  #     icoUrl: https://www.example.com/error.ico
  #     cssUrl: https://www.example.com/error.css
  #     jsUrl: https://www.example.com/error.js
  #
  # Supported error codes: 403, 404, 406, 500, 503
  # See: https://experienceleague.adobe.com/en/docs/experience-manager-cloud-service/content/implementing/content-delivery/cdn-error-pages

# =============================================================================
# DEPLOYMENT NOTES
# =============================================================================
# Current Setup (Pre-Go-Live):
#   - tmp.asahi-kasei.com → main--ak-eds--adobe-acs-japan.aem.live (IP restricted)
#   - preview.asahi-kasei.com → main--ak-eds--adobe-acs-japan.aem.page (IP restricted)
#   - Both domains mapped to prod publish tier in Cloud Manager
#
# Future Go-Live Changes Required:
#   1. Update origin selector: tmp.asahi-kasei.com → www.asahi-kasei.com
#   2. Remove/comment out "tmp-domain-ip-allowlist" rule (www should be public)
#   3. Keep "preview-domain-ip-allowlist" rule (preview stays restricted)
#   4. Add apex domain asahi-kasei.com to Cloud Manager if needed
#   5. Add apex→www redirect rule if customer wants canonical www
#   6. Keep origin selector as: ^www\\.asahi-kasei\\.com$ (only www, apex redirects)
#   7. Change WAF/rate limit actions from 'log' to 'block' when ready for production
#
# IP Restriction Strategy:
#   - preview.asahi-kasei.com: ALWAYS restricted (preview/staging content)
#   - tmp.asahi-kasei.com: Restricted during testing only
#   - www.asahi-kasei.com: Public access (NO IP restrictions after go-live)
#
# Cloud Manager Secrets Required:
#   - PREVIEW_AEM_SITE_TOKEN (for .aem.page authentication)
#   - PROD_AEM_SITE_TOKEN (for .aem.live authentication)
#
# Note: Authentication tokens are set via requestTransformations, then forwarded to EDS origins.
# =============================================================================
